<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Dmap_example (tjr_pcache_example.Tjr_pcache_example.Dmap_example)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">tjr_pcache_example</a> &#x00BB; <a href="../index.html">Tjr_pcache_example</a> &#x00BB; Dmap_example</nav><h1>Module <code>Tjr_pcache_example.Dmap_example</code></h1><nav class="toc"><ul><li><a href="#blocks-etc">Blocks etc</a></li><li><a href="#buffers">Buffers</a></li><li><a href="#marshalling-config">Marshalling config</a></li><li><a href="#type-that-captures-all-the-different-layers">Type that captures all the different layers</a></li><li><a href="#construct-the-layers">Construct the layers</a></li></ul></nav></header><aside><p>An example use of the detachable map, for an on-disk persistent cache, with key type int, value type int</p><p>Suppose the block size is B bytes. Then we need xxx bytes (1 for list elt, 1 for option tag, 9 for ptr; xxx=11) for the End_of_list marker.</p><ul><li>(B-xxx) bytes are available for data</li></ul><p>When we write eg Insert(k,v), we potentially use 1+|k|+|v| bytes. We need to be very careful that this doesn't exceed the B-xxx limit. Particularly, if values can be largeish (eg 256 bytes) we need to take great care.</p></aside><section><header><h3 id="blocks-etc"><a href="#blocks-etc" class="anchor"></a>Blocks etc</h3></header><div class="spec module" id="module-Blk_id"><a href="#module-Blk_id" class="anchor"></a><code><span class="keyword">module</span> Blk_id = Tjr_fs_shared.Blk_id_as_int</code></div><dl><dt class="spec type" id="type-blk_id"><a href="#type-blk_id" class="anchor"></a><code><span class="keyword">type</span> blk_id</code><code> = <a href="index.html#module-Blk_id">Blk_id</a>.blk_id</code></dt></dl><dl><dt class="spec value" id="val-blk_sz"><a href="#val-blk_sz" class="anchor"></a><code><span class="keyword">val</span> blk_sz : Tjr_fs_shared.Blk_sz.blk_sz</code></dt><dt class="spec value" id="val-blk_sz_as_int"><a href="#val-blk_sz_as_int" class="anchor"></a><code><span class="keyword">val</span> blk_sz_as_int : int</code></dt></dl></section><section><header><h3 id="buffers"><a href="#buffers" class="anchor"></a>Buffers</h3></header><dl><dt class="spec type" id="type-buf"><a href="#type-buf" class="anchor"></a><code><span class="keyword">type</span> buf</code><code> = Bin_prot.Common.buf</code></dt></dl><dl><dt class="spec value" id="val-create_buf"><a href="#val-create_buf" class="anchor"></a><code><span class="keyword">val</span> create_buf : int <span>&#45;&gt;</span> Bin_prot.Common.buf</code></dt></dl></section><section><header><h3 id="marshalling-config"><a href="#marshalling-config" class="anchor"></a>Marshalling config</h3></header><dl><dt class="spec module" id="module-Marshalling_config"><a href="#module-Marshalling_config" class="anchor"></a><code><span class="keyword">module</span> <a href="Marshalling_config/index.html">Marshalling_config</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Various other bits of configuration (typically how to marshal k,v etc)</p></dd></dl><dl><dt class="spec type" id="type-pcl_internal_state"><a href="#type-pcl_internal_state" class="anchor"></a><code><span class="keyword">type</span> pcl_internal_state</code><code> = </code><code>{</code><table class="record"><tr id="type-pcl_internal_state.pcl_data" class="anchored"><td class="def field"><a href="#type-pcl_internal_state.pcl_data" class="anchor"></a><code>pcl_data : <a href="index.html#type-buf">buf</a> * int;</code></td></tr></table><code>}</code></dt></dl><div class="spec module" id="module-Pcl_elt"><a href="#module-Pcl_elt" class="anchor"></a><code><span class="keyword">module</span> <a href="Pcl_elt/index.html">Pcl_elt</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec module" id="module-Pcl_read_node"><a href="#module-Pcl_read_node" class="anchor"></a><code><span class="keyword">module</span> <a href="Pcl_read_node/index.html">Pcl_read_node</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Read a node back from disk; this returns an (kvop list * ptr option)</p></dd></dl><div class="spec module" id="module-Pl_impl"><a href="#module-Pl_impl" class="anchor"></a><code><span class="keyword">module</span> <a href="Pl_impl/index.html">Pl_impl</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Pcl_impl"><a href="#module-Pcl_impl" class="anchor"></a><code><span class="keyword">module</span> <a href="Pcl_impl/index.html">Pcl_impl</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section><section><header><h3 id="type-that-captures-all-the-different-layers"><a href="#type-that-captures-all-the-different-layers" class="anchor"></a>Type that captures all the different layers</h3></header><dl><dt class="spec type" id="type-pcache_layers"><a href="#type-pcache_layers" class="anchor"></a><code><span class="keyword">type</span> <span>('k, 'v, 'r, 't, 'blk, 'pl_data, 'pl_internal_state, 'pcl_internal_state, 'fd, 'e) pcache_layers</span></code><code> = </code><code>{</code><table class="record"><tr id="type-pcache_layers.monad_ops" class="anchored"><td class="def field"><a href="#type-pcache_layers.monad_ops" class="anchor"></a><code>monad_ops : <span><span class="type-var">'t</span> Tjr_monad.monad_ops</span>;</code></td></tr><tr id="type-pcache_layers.config" class="anchored"><td class="def field"><a href="#type-pcache_layers.config" class="anchor"></a><code>config : <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'r</span>)</span> <a href="Marshalling_config/index.html#type-marshalling_config">Marshalling_config.marshalling_config</a></span>;</code></td></tr><tr id="type-pcache_layers.elt_writer" class="anchored"><td class="def field"><a href="#type-pcache_layers.elt_writer" class="anchor"></a><code>elt_writer : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'r</span>)</span> <a href="Pcl_elt/index.html#type-elt">Pcl_elt.elt</a></span> Bin_prot.Type_class.writer</span>;</code></td></tr><tr id="type-pcache_layers.elt_reader" class="anchored"><td class="def field"><a href="#type-pcache_layers.elt_reader" class="anchor"></a><code>elt_reader : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'r</span>)</span> <a href="Pcl_elt/index.html#type-elt">Pcl_elt.elt</a></span> Bin_prot.Type_class.reader</span>;</code></td></tr><tr id="type-pcache_layers.blk_write_count" class="anchored"><td class="def field"><a href="#type-pcache_layers.blk_write_count" class="anchor"></a><code>blk_write_count : <span>int Stdlib.ref</span>;</code></td></tr><tr id="type-pcache_layers.blk_ops" class="anchored"><td class="def field"><a href="#type-pcache_layers.blk_ops" class="anchor"></a><code>blk_ops : <span><span class="type-var">'blk</span> Tjr_fs_shared.blk_ops</span>;</code></td></tr><tr id="type-pcache_layers.blk_dev_ops" class="anchored"><td class="def field"><a href="#type-pcache_layers.blk_dev_ops" class="anchor"></a><code>blk_dev_ops : <span class="type-var">'fd</span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'r</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> Tjr_fs_shared.blk_dev_ops</span>;</code></td></tr><tr id="type-pcache_layers.write_node" class="anchored"><td class="def field"><a href="#type-pcache_layers.write_node" class="anchor"></a><code>write_node : <span>blk_dev_ops:<span><span>(<span class="type-var">'r</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> Tjr_fs_shared.blk_dev_ops</span></span> <span>&#45;&gt;</span> <span>pl_state:<span class="type-var">'pl_internal_state</span></span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>;</code></td></tr><tr id="type-pcache_layers.read_back" class="anchored"><td class="def field"><a href="#type-pcache_layers.read_back" class="anchor"></a><code>read_back : <span>blk_dev_ops:<span><span>(<span class="type-var">'r</span>, <span class="type-var">'blk</span>, <span class="type-var">'t</span>)</span> Tjr_fs_shared.blk_dev_ops</span></span> <span>&#45;&gt;</span> <span>blk_id:<span class="type-var">'r</span></span> <span>&#45;&gt;</span> <span><span>(<span><span><span class="type-var">'e</span> list</span> list</span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>;</code></td></tr><tr id="type-pcache_layers.pl_state_ops" class="anchored"><td class="def field"><a href="#type-pcache_layers.pl_state_ops" class="anchor"></a><code>pl_state_ops : <span><span>(<span class="type-var">'pl_data</span>, <span class="type-var">'r</span>, <span class="type-var">'pl_internal_state</span>)</span> <a href="../../../tjr_pcache/Tjr_pcache__Pcache_intf/Pl_types/index.html#type-pl_state_ops">Tjr_pcache.Pcache_intf.Pl_types.pl_state_ops</a></span>;</code></td></tr><tr id="type-pcache_layers.pcl_state_ops" class="anchored"><td class="def field"><a href="#type-pcache_layers.pcl_state_ops" class="anchor"></a><code>pcl_state_ops : <span><span>(<span class="type-var">'pl_data</span>, <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="../../../tjr_pcache/Tjr_pcache__Pcache_intf/Ins_del_op/index.html#type-op">Tjr_pcache.Pcache_intf.Ins_del_op.op</a></span>, <span class="type-var">'pcl_internal_state</span>)</span> <a href="../../../tjr_pcache/Tjr_pcache__Pcache_intf/Pcl_types/index.html#type-pcl_state_ops">Tjr_pcache.Pcache_intf.Pcl_types.pcl_state_ops</a></span>;</code></td></tr><tr id="type-pcache_layers.alloc" class="anchored"><td class="def field"><a href="#type-pcache_layers.alloc" class="anchor"></a><code>alloc : <span><span><span>(unit <span>&#45;&gt;</span> <span><span>(<span class="type-var">'r</span>, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>)</span> option</span> Stdlib.ref</span>;</code></td></tr><tr id="type-pcache_layers.with_pl" class="anchored"><td class="def field"><a href="#type-pcache_layers.with_pl" class="anchor"></a><code>with_pl : <span><span><span><span>(<span class="type-var">'pl_internal_state</span>, <span class="type-var">'t</span>)</span> Tjr_monad.with_state</span> option</span> Stdlib.ref</span>;</code></td></tr><tr id="type-pcache_layers.with_pcl" class="anchored"><td class="def field"><a href="#type-pcache_layers.with_pcl" class="anchor"></a><code>with_pcl : <span><span><span><span>(<span class="type-var">'pcl_internal_state</span>, <span class="type-var">'t</span>)</span> Tjr_monad.with_state</span> option</span> Stdlib.ref</span>;</code></td></tr><tr id="type-pcache_layers.with_dmap" class="anchored"><td class="def field"><a href="#type-pcache_layers.with_dmap" class="anchor"></a><code>with_dmap : <span><span><span><span>(<span><span>(<span class="type-var">'r</span>, <span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="../../../tjr_pcache/Tjr_pcache__Pcache_intf/Dmap_types/index.html#type-dmap_state">Tjr_pcache.Pcache_intf.Dmap_types.dmap_state</a></span>, <span class="type-var">'t</span>)</span> Tjr_monad.with_state</span> option</span> Stdlib.ref</span>;</code></td></tr><tr id="type-pcache_layers.dmap_ops" class="anchored"><td class="def field"><a href="#type-pcache_layers.dmap_ops" class="anchor"></a><code>dmap_ops : <span>write_node:<span>(<span class="type-var">'pl_internal_state</span> <span>&#45;&gt;</span> <span><span>(unit, <span class="type-var">'t</span>)</span> Tjr_monad.m</span>)</span></span> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'r</span>, <span class="type-var">'t</span>)</span> <a href="../../../tjr_pcache/Tjr_pcache__Pcache_intf/Dmap_types/index.html#type-dmap_ops">Tjr_pcache.Pcache_intf.Dmap_types.dmap_ops</a></span>;</code></td></tr></table><code>}</code></dt><dd><p>NOTE in the following type, the option refs have to be initialized before calling dmap_ops</p></dd></dl></section><section><header><h3 id="construct-the-layers"><a href="#construct-the-layers" class="anchor"></a>Construct the layers</h3></header><dl><dt class="spec module" id="module-Make_layers"><a href="#module-Make_layers" class="anchor"></a><code><span class="keyword">module</span> <a href="Make_layers/index.html">Make_layers</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Use the Pcache_intf.pcache_layers type</p></dd></dl></section></div></body></html>