<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="Start" href="index.html">
<link rel="Up" href="Gom.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Gom" rel="Chapter" href="Gom.html">
<link title="Pcache_debug" rel="Chapter" href="Pcache_debug.html">
<link title="Persistent_chunked_list" rel="Chapter" href="Persistent_chunked_list.html">
<link title="Persistent_list" rel="Chapter" href="Persistent_list.html">
<link title="Persistent_log" rel="Chapter" href="Persistent_log.html">
<link title="Tjr_pcache_doc" rel="Chapter" href="Tjr_pcache_doc.html"><title>Gom.Make_gom</title>
</head>
<body>
<div class="navbar">&nbsp;<a class="up" href="Gom.html" title="Gom">Up</a>
&nbsp;</div>
<h1>Functor <a href="type_Gom.Make_gom.html">Gom.Make_gom</a></h1>

<pre><span id="MODULEMake_gom"><span class="keyword">module</span> Make_gom</span>: <div class="sig_block"><code class="code">functor (</code><code class="code">Gom_requires</code><code class="code"> : </code><code class="code">sig</code></pre><div class="sig_block">
<pre><span id="MODULEBt_blk_id"><span class="keyword">module</span> <a href="Gom.Bt_blk_id.html">Bt_blk_id</a></span>: <code class="type">Tjr_int.TYPE_ISOMORPHIC_TO_INT</code><code class="type"> </code></pre>
<pre><span id="MODULEPc_blk_id"><span class="keyword">module</span> <a href="Gom.Pc_blk_id.html">Pc_blk_id</a></span>: <code class="type">Tjr_int.TYPE_ISOMORPHIC_TO_INT</code><code class="type"> </code></pre></div><pre><code class="code">end</code><code class="code">) -&gt; </code><code class="code">sig</code> <a href="Gom.Make_gom.html">..</a> <code class="code">end</code></div></pre><table border="0" cellpadding="3" width="100%">
<tr>
<td align="left" valign="top" width="1%%"><b>Parameters: </b></td>
<td>
<table class="paramstable">
<tr>
<td align="center" valign="top" width="15%">
<code>Gom_requires</code></td>
<td align="center" valign="top">:</td>
<td><code class="type">sig 
    module Bt_blk_id:Tjr_int.TYPE_ISOMORPHIC_TO_INT
    module Pc_blk_id:Tjr_int.TYPE_ISOMORPHIC_TO_INT (* NOTE only needed for testing; otherwise abstract *)
  end</code>
</table>
</td>
</tr>
</table>
<hr width="100%">

<pre><span id="TYPEbt_blk_id"><span class="keyword">type</span> <code class="type"></code>bt_blk_id</span> = <code class="type">Gom_requires.Bt_blk_id.t</code> </pre>


<pre><span id="TYPEpc_blk_id"><span class="keyword">type</span> <code class="type"></code>pc_blk_id</span> = <code class="type">Gom_requires.Pc_blk_id.t</code> </pre>


<pre><code><span id="TYPEgom_state"><span class="keyword">type</span> <code class="type"></code>gom_state</span> = {</code></pre><table class="typetable">
<tr>
<td align="left" valign="top" >
<code>&nbsp;&nbsp;</code></td>
<td align="left" valign="top" >
<code><span id="TYPEELTgom_state.in_roll_up">in_roll_up</span>&nbsp;: <code class="type">bool</code>;</code></td>

</tr>
<tr>
<td align="left" valign="top" >
<code>&nbsp;&nbsp;</code></td>
<td align="left" valign="top" >
<code><span id="TYPEELTgom_state.pcache_root">pcache_root</span>&nbsp;: <code class="type"><a href="Gom.Make_gom.html#TYPEpc_blk_id">pc_blk_id</a></code>;</code></td>

</tr>
<tr>
<td align="left" valign="top" >
<code>&nbsp;&nbsp;</code></td>
<td align="left" valign="top" >
<code><span id="TYPEELTgom_state.btree_root">btree_root</span>&nbsp;: <code class="type"><a href="Gom.Make_gom.html#TYPEbt_blk_id">bt_blk_id</a></code>;</code></td>

</tr></table>
}

<div class="info ">
<div class="info-desc">
<p>The gom state. Fields:</p>
<ul>
<li><code class="code">in_roll_up</code>: a flag covering the critical section when we are executing a roll up</li>
<li><code class="code">pcache_root</code>: the root of the pcache</li>
<li><code class="code">btree_root</code>: the root of the B-tree</li>
</ul>
</div>
</div>


<pre><span id="TYPEgom_state_ops"><span class="keyword">type</span> <code class="type">'t</code> gom_state_ops</span> = <code class="type">(<a href="Gom.Make_gom.html#TYPEgom_state">gom_state</a>, 't) Tjr_monad.Mref_plus.mref</code> </pre>


<pre><span id="TYPEgom_ops"><span class="keyword">type</span> <code class="type">('k, 'v, 't)</code> gom_ops</span> = <code class="type">('k, 'v, 't) Tjr_btree.Map_ops.map_ops</code> </pre>


<pre><span id="VALmake_gom_ops"><span class="keyword">val</span> make_gom_ops</span> : <code class="type">monad_ops:'t Tjr_monad.Monad.monad_ops -><br>       btree_ops:('k, 'v, 't) Tjr_btree.Map_ops.map_ops -><br>       pcache_ops:('k, 'v, 'map, <a href="Gom.Make_gom.html#TYPEpc_blk_id">pc_blk_id</a>, 't) <a href="Persistent_log.html#TYPEplog_ops">Persistent_log.plog_ops</a> -><br>       pcache_blocks_limit:int -><br>       gom_mref_ops:(<a href="Gom.Make_gom.html#TYPEgom_state">gom_state</a>, 't) Tjr_monad.Mref_plus.mref -><br>       kvop_map_bindings:('map -> ('k, 'v) <a href="Persistent_log.html#TYPEop">Persistent_log.op</a> list) -><br>       bt_sync:(unit -> (<a href="Gom.Make_gom.html#TYPEbt_blk_id">bt_blk_id</a>, 't) Tjr_monad.Monad.m) -><br>       sync_gom_roots:(btree_root:<a href="Gom.Make_gom.html#TYPEbt_blk_id">bt_blk_id</a> -><br>                       pcache_root:<a href="Gom.Make_gom.html#TYPEpc_blk_id">pc_blk_id</a> -><br>                       (unit, 't) Tjr_monad.Monad.m) -><br>       ('k, 'v, 't) <a href="Gom.Make_gom.html#TYPEgom_ops">gom_ops</a></code></pre><div class="info ">
<div class="info-desc">
<p>Construct the GOM. Parameters:</p>
<ul>
<li><code class="code">monad_ops</code></li>
<li><code class="code">btree_ops</code></li>
<li><code class="code">pcache_ops</code></li>
<li><code class="code">pcache_blocks_limit</code>: how many blocks in the pcache before attempting a roll-up; if the length of pcache is <code class="code">&gt;=</code> this limit, we attempt a roll-up; NOTE that this limit should be &gt;= 2 (if we roll up with 1 block, then in fact nothing gets rolled up because we roll up "upto" the current block; not a problem but probably pointless for testing)</li>
<li><code class="code">gom_mref_ops</code>: a reference to the gom state; the pcache and btree roots get updated (also <code class="code">in_roll_up</code> is updated)</li>
<li><code class="code">detach_map_ops</code>: used to get the bindings for the blocks that have been detached from the pcache</li>
<li><code class="code">bt_sync</code>: at the end of the roll-up, we sync the B-tree itself to disk</li>
<li><code class="code">sync_gom_roots</code>: called just before leaving the critical section, to record new roots for B-tree and pcache</li>
</ul>
</div>
</div>

<pre><span id="MODULETest"><span class="keyword">module</span> <a href="Gom.Make_gom.Test.html">Test</a></span>: <div class="sig_block"><code class="code">functor (</code><code class="code">*</code><code class="code"> : </code><code class="code">sig</code></pre><div class="sig_block"></div><pre><code class="code">end</code><code class="code">) -&gt; </code><code class="code">sig</code> <a href="Gom.Make_gom.Test.html">..</a> <code class="code">end</code></div></pre></body></html>